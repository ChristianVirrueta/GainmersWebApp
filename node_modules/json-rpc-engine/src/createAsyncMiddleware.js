const promiseToCallback = require('promise-to-callback')

module.exports = createAsyncMiddleware


function createAsyncMiddleware(asyncMiddleware) {
  return (req, res, next, end) => {
<<<<<<< HEAD
    let nextHandlerOnDone = null
    const finishedPromise = asyncMiddleware(req, res, getNextPromise)
    promiseToCallback(finishedPromise)((err) => {
      // async middleware ended
      if (nextHandlerOnDone) {
        // next handler was called - complete nextHandler
        nextHandlerOnDone(err)
=======
    let nextDonePromise = null
    const finishedPromise = asyncMiddleware(req, res, getNextPromise)
    promiseToCallback(finishedPromise)((err) => {
      // async middleware ended
      if (nextDonePromise) {
        console.log('detected next was called')
        // next handler was called - complete nextHandler
        promiseToCallback(nextDonePromise)((nextErr, nextHandlerSignalDone) => {
          if (nextErr) return done(nextErr)
          nextHandlerSignalDone(err)
        })
>>>>>>> ee05fcfdee6a35b5e51354575454dbbb7254033e
      } else {
        // next handler was not called - complete middleware
        end(err)
      }
    })

<<<<<<< HEAD
    function getNextPromise() {
      return new Promise((resolve) => {
        next((cb) => {
          nextHandlerOnDone = cb
          resolve()
        })
      })
    }
  }
}
=======
    async function getNextPromise() {
      nextDonePromise = getNextDoneCallback()
      await nextDonePromise
      return undefined
    }

    function getNextDoneCallback() {
      return new Promise((resolve) => {
        next((cb) => resolve(cb))
      })
    }
  }
}
>>>>>>> ee05fcfdee6a35b5e51354575454dbbb7254033e
